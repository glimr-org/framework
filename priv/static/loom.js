var D={wsPath:"/loom/ws",reconnectInterval:1000,maxReconnectAttempts:10,defaultDebounce:150},r=["click","input","change","submit","keydown","keyup","focus","blur"];var o=11;function Dz(z,J){var Q=J.attributes,Z,j,X,V,I;if(J.nodeType===o||z.nodeType===o)return;for(var B=Q.length-1;B>=0;B--)if(Z=Q[B],j=Z.name,X=Z.namespaceURI,V=Z.value,X){if(j=Z.localName||j,I=z.getAttributeNS(X,j),I!==V){if(Z.prefix==="xmlns")j=Z.name;z.setAttributeNS(X,j,V)}}else if(I=z.getAttribute(j),I!==V)z.setAttribute(j,V);var K=z.attributes;for(var U=K.length-1;U>=0;U--)if(Z=K[U],j=Z.name,X=Z.namespaceURI,X){if(j=Z.localName||j,!J.hasAttributeNS(X,j))z.removeAttributeNS(X,j)}else if(!J.hasAttribute(j))z.removeAttribute(j)}var C,Lz="http://www.w3.org/1999/xhtml",G=typeof document>"u"?void 0:document,Iz=!!G&&"content"in G.createElement("template"),Sz=!!G&&G.createRange&&"createContextualFragment"in G.createRange();function Az(z){var J=G.createElement("template");return J.innerHTML=z,J.content.childNodes[0]}function wz(z){if(!C)C=G.createRange(),C.selectNode(G.body);var J=C.createContextualFragment(z);return J.childNodes[0]}function Uz(z){var J=G.createElement("body");return J.innerHTML=z,J.childNodes[0]}function kz(z){if(z=z.trim(),Iz)return Az(z);else if(Sz)return wz(z);return Uz(z)}function f(z,J){var Q=z.nodeName,Z=J.nodeName,j,X;if(Q===Z)return!0;if(j=Q.charCodeAt(0),X=Z.charCodeAt(0),j<=90&&X>=97)return Q===Z.toUpperCase();else if(X<=90&&j>=97)return Z===Q.toUpperCase();else return!1}function Kz(z,J){return!J||J===Lz?G.createElement(z):G.createElementNS(J,z)}function Oz(z,J){var Q=z.firstChild;while(Q){var Z=Q.nextSibling;J.appendChild(Q),Q=Z}return J}function n(z,J,Q){if(z[Q]!==J[Q])if(z[Q]=J[Q],z[Q])z.setAttribute(Q,"");else z.removeAttribute(Q)}var e={OPTION:function(z,J){var Q=z.parentNode;if(Q){var Z=Q.nodeName.toUpperCase();if(Z==="OPTGROUP")Q=Q.parentNode,Z=Q&&Q.nodeName.toUpperCase();if(Z==="SELECT"&&!Q.hasAttribute("multiple")){if(z.hasAttribute("selected")&&!J.selected)z.setAttribute("selected","selected"),z.removeAttribute("selected");Q.selectedIndex=-1}}n(z,J,"selected")},INPUT:function(z,J){if(n(z,J,"checked"),n(z,J,"disabled"),z.value!==J.value)z.value=J.value;if(!J.hasAttribute("value"))z.removeAttribute("value")},TEXTAREA:function(z,J){var Q=J.value;if(z.value!==Q)z.value=Q;var Z=z.firstChild;if(Z){var j=Z.nodeValue;if(j==Q||!Q&&j==z.placeholder)return;Z.nodeValue=Q}},SELECT:function(z,J){if(!J.hasAttribute("multiple")){var Q=-1,Z=0,j=z.firstChild,X,V;while(j)if(V=j.nodeName&&j.nodeName.toUpperCase(),V==="OPTGROUP"){if(X=j,j=X.firstChild,!j)j=X.nextSibling,X=null}else{if(V==="OPTION"){if(j.hasAttribute("selected")){Q=Z;break}Z++}if(j=j.nextSibling,!j&&X)j=X.nextSibling,X=null}z.selectedIndex=Q}}},k=1,zz=11,Jz=3,Qz=8;function L(){}function Rz(z){if(z)return z.getAttribute&&z.getAttribute("id")||z.id}function bz(z){return function(Q,Z,j){if(!j)j={};if(typeof Z==="string")if(Q.nodeName==="#document"||Q.nodeName==="HTML"){var X=Z;Z=G.createElement("html"),Z.innerHTML=X}else if(Q.nodeName==="BODY"){var V=Z;Z=G.createElement("html"),Z.innerHTML=V;var I=Z.querySelector("body");if(I)Z=I}else Z=kz(Z);else if(Z.nodeType===zz)Z=Z.firstElementChild;var B=j.getNodeKey||Rz,K=j.onBeforeNodeAdded||L,U=j.onNodeAdded||L,Hz=j.onBeforeElUpdated||L,Pz=j.onElUpdated||L,Gz=j.onBeforeNodeDiscarded||L,O=j.onNodeDiscarded||L,Bz=j.onBeforeElChildrenUpdated||L,Vz=j.skipFromChildren||L,m=j.addChild||function(q,Y){return q.appendChild(Y)},h=j.childrenOnly===!0,S=Object.create(null),R=[];function b(q){R.push(q)}function l(q,Y){if(q.nodeType===k){var H=q.firstChild;while(H){var $=void 0;if(Y&&($=B(H)))b($);else if(O(H),H.firstChild)l(H,Y);H=H.nextSibling}}}function v(q,Y,H){if(Gz(q)===!1)return;if(Y)Y.removeChild(q);O(q),l(q,H)}function u(q){if(q.nodeType===k||q.nodeType===zz){var Y=q.firstChild;while(Y){var H=B(Y);if(H)S[H]=Y;u(Y),Y=Y.nextSibling}}}u(Q);function p(q){U(q);var Y=q.firstChild;while(Y){var H=Y.nextSibling,$=B(Y);if($){var W=S[$];if(W&&f(Y,W))Y.parentNode.replaceChild(W,Y),F(W,Y);else p(Y)}else p(Y);Y=H}}function Mz(q,Y,H){while(Y){var $=Y.nextSibling;if(H=B(Y))b(H);else v(Y,q,!0);Y=$}}function F(q,Y,H){var $=B(Y);if($)delete S[$];if(!H){var W=Hz(q,Y);if(W===!1)return;else if(W instanceof HTMLElement)q=W,u(q);if(z(q,Y),Pz(q),Bz(q,Y)===!1)return}if(q.nodeName!=="TEXTAREA")_z(q,Y);else e.TEXTAREA(q,Y)}function _z(q,Y){var H=Vz(q,Y),$=Y.firstChild,W=q.firstChild,A,M,w,g,_;z:while($){g=$.nextSibling,A=B($);while(!H&&W){if(w=W.nextSibling,$.isSameNode&&$.isSameNode(W)){$=g,W=w;continue z}M=B(W);var y=W.nodeType,x=void 0;if(y===$.nodeType){if(y===k){if(A){if(A!==M)if(_=S[A])if(w===_)x=!1;else{if(q.insertBefore(_,W),M)b(M);else v(W,q,!0);W=_,M=B(W)}else x=!1}else if(M)x=!1;if(x=x!==!1&&f(W,$),x)F(W,$)}else if(y===Jz||y==Qz){if(x=!0,W.nodeValue!==$.nodeValue)W.nodeValue=$.nodeValue}}if(x){$=g,W=w;continue z}if(M)b(M);else v(W,q,!0);W=w}if(A&&(_=S[A])&&f(_,$)){if(!H)m(q,_);F(_,$)}else{var N=K($);if(N!==!1){if(N)$=N;if($.actualize)$=$.actualize(q.ownerDocument||G);m(q,$),p($)}}$=g,W=w}Mz(q,W,M);var d=e[q.nodeName];if(d)d(q,Y)}var P=Q,T=P.nodeType,t=Z.nodeType;if(!h){if(T===k)if(t===k){if(!f(Q,Z))O(Q),P=Oz(Q,Kz(Z.nodeName,Z.namespaceURI))}else P=Z;else if(T===Jz||T===Qz)if(t===T){if(P.nodeValue!==Z.nodeValue)P.nodeValue=Z.nodeValue;return P}else P=Z}if(P===Z)O(Q);else{if(Z.isSameNode&&Z.isSameNode(P))return;if(F(P,Z,h),R)for(var c=0,xz=R.length;c<xz;c++){var s=S[R[c]];if(s)v(s,s.parentNode,!1)}}if(!h&&P!==Q&&Q.parentNode){if(P.actualize)P=P.actualize(Q.ownerDocument||G);Q.parentNode.replaceChild(P,Q)}return P}}var vz=bz(Dz),Zz=vz;function jz(z,J){if(z&&z.startsWith("ws"))return z;let Q=J.protocol==="https:"?"wss:":"ws:",Z=z||D.wsPath;return`${Q}//${J.host}${Z}`}function qz(z){return{prevent:z.dataset.lPrevent==="true",stop:z.dataset.lStop==="true",shouldDebounce:z.dataset.lDebounce!==void 0,debounce:parseInt(z.dataset.lDebounce||"")||D.defaultDebounce}}function Yz(z){let J={},Q=z.target;if(Q.value!==void 0)J.value=Q.value;if(Q.type==="checkbox"||Q.type==="radio")J.checked=Q.checked;if(z.key!==void 0)J.key=z.key;return J}function $z(){let z=document.activeElement,J=z,Q=!!z&&(z.tagName==="INPUT"||z.tagName==="TEXTAREA");return{element:z,isInput:Q,selectionStart:J?.selectionStart??null,selectionEnd:J?.selectionEnd??null,handlerId:z?.dataset?.lInput||z?.dataset?.lChange||z?.id}}function Wz(z,J){if(!J.isInput||!J.handlerId)return;let Q=z.querySelector(`[data-l-input="${J.handlerId}"], [data-l-change="${J.handlerId}"], #${J.handlerId}`);if(!Q)return;if(Q.focus(),typeof J.selectionStart==="number"&&typeof J.selectionEnd==="number")try{Q.setSelectionRange(J.selectionStart,J.selectionEnd)}catch{}}function Xz(z){if(z.nodeType!==1)return null;let J=z;return J.dataset?.lInput||J.dataset?.lClick||J.dataset?.lChange||J.dataset?.lSubmit||J.id||null}var i=new WeakMap;class E{container;module;initialProps;wsUrlOverride;socket=null;reconnectAttempts=0;connected=!1;initialized=!1;pendingEvents=[];constructor(z){this.container=z,this.module=z.dataset.lLive,this.initialProps=z.dataset.lProps||"{}",this.wsUrlOverride=z.dataset.lWs||null,this.connect(),this.attachEventListeners()}connect(){let z=jz(this.wsUrlOverride,window.location);this.socket=new WebSocket(z),this.socket.onopen=()=>{console.log("[Loom] Connected:",this.module),this.connected=!0,this.reconnectAttempts=0,this.sendInit()},this.socket.onmessage=(J)=>{this.handleMessage(JSON.parse(J.data))},this.socket.onclose=()=>{console.log("[Loom] Disconnected:",this.module),this.connected=!1,this.initialized=!1,this.attemptReconnect()},this.socket.onerror=(J)=>{console.error("[Loom] WebSocket error:",J)}}sendInit(){this.socket.send(JSON.stringify({type:"init",module:this.module,props:this.initialProps})),this.initialized=!0;while(this.pendingEvents.length>0)this.send(this.pendingEvents.shift())}attemptReconnect(){if(this.reconnectAttempts>=D.maxReconnectAttempts){console.error("[Loom] Max reconnect attempts reached");return}this.reconnectAttempts++;let z=D.reconnectInterval*Math.pow(2,this.reconnectAttempts-1);console.log(`[Loom] Reconnecting in ${z}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{if(!this.connected)this.connect()},z)}send(z){if(this.connected&&this.initialized&&this.socket?.readyState===WebSocket.OPEN)this.socket.send(JSON.stringify(z));else this.pendingEvents.push(z)}handleMessage(z){switch(z.type){case"patch":this.applyPatch(z.html);break;case"redirect":window.location.href=z.url;break;case"error":console.error("[Loom] Server error:",z.error);break;default:console.warn("[Loom] Unknown message type:",z.type)}}applyPatch(z){let J=$z(),Q=document.createElement("div");Q.innerHTML=z,Zz(this.container,Q,{childrenOnly:!0,getNodeKey:Xz,onBeforeElUpdated:(Z,j)=>{if(Z===J.element&&J.isInput)j.value=Z.value;return!0}}),this.attachEventListeners(),Wz(this.container,J)}attachEventListeners(){this.container.querySelectorAll("[data-l-click], [data-l-input], [data-l-change], [data-l-submit], [data-l-keydown], [data-l-keyup], [data-l-focus], [data-l-blur]").forEach((J)=>this.attachElementListeners(J))}attachElementListeners(z){if(z._loomAttached)return;z._loomAttached=!0;let J=qz(z);r.forEach((Q)=>{let Z=z.dataset[`l${Q.charAt(0).toUpperCase()+Q.slice(1)}`];if(!Z)return;z.addEventListener(Q,(j)=>{this.handleEvent(j,Q,Z,J)})})}handleEvent(z,J,Q,Z){if(Z.prevent)z.preventDefault();if(Z.stop)z.stopPropagation();let j={handler:Q,event:J,special_vars:Yz(z)};if(Z.shouldDebounce)this.debouncedSend(z.target,j,Z.debounce);else this.send(j)}debouncedSend(z,J,Q){clearTimeout(i.get(z)),i.set(z,setTimeout(()=>{i.delete(z),this.send(J)},Q))}destroy(){if(this.socket)this.socket.close(),this.socket=null;this.connected=!1,this.initialized=!1}}var a=()=>{let z=document.querySelectorAll("[data-l-live]");z.forEach((J)=>{if(J._loomInstance)return;J._loomInstance=new E(J)}),console.log(`[Loom] Initialized ${z.length} live component(s)`)};a();window.Loom={init:a,reinit:a,LoomLive:E,CONFIG:D};
