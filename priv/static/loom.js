var M={wsPath:"/loom/ws",reconnectInterval:1000,maxReconnectAttempts:10,defaultDebounce:150,navPrefetchDelay:65,navCacheTTL:30000,navCacheMaxEntries:20},qJ=["click","input","change","submit","keydown","keyup","focus","blur"];function YJ(J,Q){if(J&&J.startsWith("ws"))return J;let j=Q.protocol==="https:"?"wss:":"ws:",Z=J||M.wsPath;return`${j}//${Q.host}${Z}`}function WJ(J){return{prevent:J.dataset.lPrevent==="true",stop:J.dataset.lStop==="true",shouldDebounce:J.dataset.lDebounce!==void 0,debounce:parseInt(J.dataset.lDebounce||"")||M.defaultDebounce}}function $J(J){let Q={},j=J.target;if(j.value!==void 0)Q.value=j.value;if(j.type==="checkbox"||j.type==="radio")Q.checked=j.checked;if(J.key!==void 0)Q.key=J.key;return Q}function XJ(){let J=document.activeElement,Q=J,j=!!J&&(J.tagName==="INPUT"||J.tagName==="TEXTAREA");return{element:J,isInput:j,selectionStart:Q?.selectionStart??null,selectionEnd:Q?.selectionEnd??null,handlerId:J?.dataset?.lInput||J?.dataset?.lChange||J?.id}}function zJ(J,Q){if(!Q.isInput||!Q.handlerId)return;let j=J.querySelector(`[data-l-input="${Q.handlerId}"], [data-l-change="${Q.handlerId}"], #${Q.handlerId}`);if(!j)return;if(j.focus(),typeof Q.selectionStart==="number"&&typeof Q.selectionEnd==="number")try{j.setSelectionRange(Q.selectionStart,Q.selectionEnd)}catch{}}function BJ(J){if(J.nodeType!==1)return null;let Q=J;return Q.dataset?.lInput||Q.dataset?.lClick||Q.dataset?.lChange||Q.dataset?.lSubmit||Q.id||null}class y{socket=null;connected=!1;reconnectAttempts=0;nextId=0;handlers=new Map;reconnectCallbacks=[];pendingMessages=[];wsUrlOverride;constructor(J){this.wsUrlOverride=J??null,this.connect()}allocateId(){return`c${this.nextId++}`}register(J,Q){this.handlers.set(J,Q)}unregister(J){this.handlers.delete(J),this.send({type:"leave",id:J})}send(J){if(this.connected&&this.socket?.readyState===WebSocket.OPEN)this.socket.send(JSON.stringify(J));else this.pendingMessages.push(J)}onReconnect(J){return this.reconnectCallbacks.push(J),()=>{let Q=this.reconnectCallbacks.indexOf(J);if(Q!==-1)this.reconnectCallbacks.splice(Q,1)}}destroy(){for(let J of this.handlers.keys())this.send({type:"leave",id:J});if(this.handlers.clear(),this.reconnectCallbacks=[],this.socket)this.socket.onclose=null,this.socket.close(),this.socket=null;this.connected=!1}connect(){let J=YJ(this.wsUrlOverride,window.location);this.socket=new WebSocket(J),this.socket.onopen=()=>{if(console.log("[Loom] Socket connected"),this.connected=!0,this.reconnectAttempts=0,this.flushPending(),this.reconnectCallbacks.length>0)this.reconnectCallbacks.forEach((Q)=>Q())},this.socket.onmessage=(Q)=>{this.routeMessage(JSON.parse(Q.data))},this.socket.onclose=()=>{console.log("[Loom] Socket disconnected"),this.connected=!1,this.attemptReconnect()},this.socket.onerror=(Q)=>{console.error("[Loom] Socket error:",Q)}}flushPending(){while(this.pendingMessages.length>0){let J=this.pendingMessages.shift();this.socket.send(JSON.stringify(J))}}routeMessage(J){if(J.type==="redirect"){if(window.Loom?.nav)window.Loom.nav.navigate(J.url);else window.location.href=J.url;return}if(J.id){let Q=this.handlers.get(J.id);if(Q)Q(J)}}attemptReconnect(){if(this.reconnectAttempts>=M.maxReconnectAttempts){console.error("[Loom] Max reconnect attempts reached");return}this.reconnectAttempts++;let J=M.reconnectInterval*Math.pow(2,this.reconnectAttempts-1);console.log(`[Loom] Reconnecting in ${J}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{if(!this.connected)this.connect()},J)}}var GJ=11;function bJ(J,Q){var j=Q.attributes,Z,q,Y,X,G;if(Q.nodeType===GJ||J.nodeType===GJ)return;for(var H=j.length-1;H>=0;H--)if(Z=j[H],q=Z.name,Y=Z.namespaceURI,X=Z.value,Y){if(q=Z.localName||q,G=J.getAttributeNS(Y,q),G!==X){if(Z.prefix==="xmlns")q=Z.name;J.setAttributeNS(Y,q,X)}}else if(G=J.getAttribute(q),G!==X)J.setAttribute(q,X);var _=J.attributes;for(var R=_.length-1;R>=0;R--)if(Z=_[R],q=Z.name,Y=Z.namespaceURI,Y){if(q=Z.localName||q,!Q.hasAttributeNS(Y,q))J.removeAttributeNS(Y,q)}else if(!Q.hasAttribute(q))J.removeAttribute(q)}var E,xJ="http://www.w3.org/1999/xhtml",A=typeof document>"u"?void 0:document,kJ=!!A&&"content"in A.createElement("template"),FJ=!!A&&A.createRange&&"createContextualFragment"in A.createRange();function TJ(J){var Q=A.createElement("template");return Q.innerHTML=J,Q.content.childNodes[0]}function vJ(J){if(!E)E=A.createRange(),E.selectNode(A.body);var Q=E.createContextualFragment(J);return Q.childNodes[0]}function CJ(J){var Q=A.createElement("body");return Q.innerHTML=J,Q.childNodes[0]}function gJ(J){if(J=J.trim(),kJ)return TJ(J);else if(FJ)return vJ(J);return CJ(J)}function f(J,Q){var j=J.nodeName,Z=Q.nodeName,q,Y;if(j===Z)return!0;if(q=j.charCodeAt(0),Y=Z.charCodeAt(0),q<=90&&Y>=97)return j===Z.toUpperCase();else if(Y<=90&&q>=97)return Z===j.toUpperCase();else return!1}function yJ(J,Q){return!Q||Q===xJ?A.createElement(J):A.createElementNS(Q,J)}function EJ(J,Q){var j=J.firstChild;while(j){var Z=j.nextSibling;Q.appendChild(j),j=Z}return Q}function d(J,Q,j){if(J[j]!==Q[j])if(J[j]=Q[j],J[j])J.setAttribute(j,"");else J.removeAttribute(j)}var HJ={OPTION:function(J,Q){var j=J.parentNode;if(j){var Z=j.nodeName.toUpperCase();if(Z==="OPTGROUP")j=j.parentNode,Z=j&&j.nodeName.toUpperCase();if(Z==="SELECT"&&!j.hasAttribute("multiple")){if(J.hasAttribute("selected")&&!Q.selected)J.setAttribute("selected","selected"),J.removeAttribute("selected");j.selectedIndex=-1}}d(J,Q,"selected")},INPUT:function(J,Q){if(d(J,Q,"checked"),d(J,Q,"disabled"),J.value!==Q.value)J.value=Q.value;if(!Q.hasAttribute("value"))J.removeAttribute("value")},TEXTAREA:function(J,Q){var j=Q.value;if(J.value!==j)J.value=j;var Z=J.firstChild;if(Z){var q=Z.nodeValue;if(q==j||!j&&q==J.placeholder)return;Z.nodeValue=j}},SELECT:function(J,Q){if(!Q.hasAttribute("multiple")){var j=-1,Z=0,q=J.firstChild,Y,X;while(q)if(X=q.nodeName&&q.nodeName.toUpperCase(),X==="OPTGROUP"){if(Y=q,q=Y.firstChild,!q)q=Y.nextSibling,Y=null}else{if(X==="OPTION"){if(q.hasAttribute("selected")){j=Z;break}Z++}if(q=q.nextSibling,!q&&Y)q=Y.nextSibling,Y=null}J.selectedIndex=j}}},S=1,PJ=11,VJ=3,_J=8;function O(){}function fJ(J){if(J)return J.getAttribute&&J.getAttribute("id")||J.id}function uJ(J){return function(j,Z,q){if(!q)q={};if(typeof Z==="string")if(j.nodeName==="#document"||j.nodeName==="HTML"){var Y=Z;Z=A.createElement("html"),Z.innerHTML=Y}else if(j.nodeName==="BODY"){var X=Z;Z=A.createElement("html"),Z.innerHTML=X;var G=Z.querySelector("body");if(G)Z=G}else Z=gJ(Z);else if(Z.nodeType===PJ)Z=Z.firstElementChild;var H=q.getNodeKey||fJ,_=q.onBeforeNodeAdded||O,R=q.onNodeAdded||O,IJ=q.onBeforeElUpdated||O,KJ=q.onElUpdated||O,OJ=q.onBeforeNodeDiscarded||O,b=q.onNodeDiscarded||O,RJ=q.onBeforeElChildrenUpdated||O,LJ=q.skipFromChildren||O,JJ=q.addChild||function(W,$){return W.appendChild($)},s=q.childrenOnly===!0,L=Object.create(null),x=[];function k(W){x.push(W)}function QJ(W,$){if(W.nodeType===S){var P=W.firstChild;while(P){var z=void 0;if($&&(z=H(P)))k(z);else if(b(P),P.firstChild)QJ(P,$);P=P.nextSibling}}}function F(W,$,P){if(OJ(W)===!1)return;if($)$.removeChild(W);b(W),QJ(W,P)}function m(W){if(W.nodeType===S||W.nodeType===PJ){var $=W.firstChild;while($){var P=H($);if(P)L[P]=$;m($),$=$.nextSibling}}}m(j);function a(W){R(W);var $=W.firstChild;while($){var P=$.nextSibling,z=H($);if(z){var B=L[z];if(B&&f($,B))$.parentNode.replaceChild(B,$),T(B,$);else a($)}else a($);$=P}}function UJ(W,$,P){while($){var z=$.nextSibling;if(P=H($))k(P);else F($,W,!0);$=z}}function T(W,$,P){var z=H($);if(z)delete L[z];if(!P){var B=IJ(W,$);if(B===!1)return;else if(B instanceof HTMLElement)W=B,m(W);if(J(W,$),KJ(W),RJ(W,$)===!1)return}if(W.nodeName!=="TEXTAREA")wJ(W,$);else HJ.TEXTAREA(W,$)}function wJ(W,$){var P=LJ(W,$),z=$.firstChild,B=W.firstChild,U,D,w,C,I;J:while(z){C=z.nextSibling,U=H(z);while(!P&&B){if(w=B.nextSibling,z.isSameNode&&z.isSameNode(B)){z=C,B=w;continue J}D=H(B);var g=B.nodeType,K=void 0;if(g===z.nodeType){if(g===S){if(U){if(U!==D)if(I=L[U])if(w===I)K=!1;else{if(W.insertBefore(I,B),D)k(D);else F(B,W,!0);B=I,D=H(B)}else K=!1}else if(D)K=!1;if(K=K!==!1&&f(B,z),K)T(B,z)}else if(g===VJ||g==_J){if(K=!0,B.nodeValue!==z.nodeValue)B.nodeValue=z.nodeValue}}if(K){z=C,B=w;continue J}if(D)k(D);else F(B,W,!0);B=w}if(U&&(I=L[U])&&f(I,z)){if(!P)JJ(W,I);T(I,z)}else{var l=_(z);if(l!==!1){if(l)z=l;if(z.actualize)z=z.actualize(W.ownerDocument||A);JJ(W,z),a(z)}}z=C,B=w}UJ(W,B,D);var jJ=HJ[W.nodeName];if(jJ)jJ(W,$)}var V=j,v=V.nodeType,ZJ=Z.nodeType;if(!s){if(v===S)if(ZJ===S){if(!f(j,Z))b(j),V=EJ(j,yJ(Z.nodeName,Z.namespaceURI))}else V=Z;else if(v===VJ||v===_J)if(ZJ===v){if(V.nodeValue!==Z.nodeValue)V.nodeValue=Z.nodeValue;return V}else V=Z}if(V===Z)b(j);else{if(Z.isSameNode&&Z.isSameNode(V))return;if(T(V,Z,s),x)for(var i=0,SJ=x.length;i<SJ;i++){var n=L[x[i]];if(n)F(n,n.parentNode,!1)}}if(!s&&V!==j&&j.parentNode){if(V.actualize)V=V.actualize(j.ownerDocument||A);j.parentNode.replaceChild(V,j)}return V}}var hJ=uJ(bJ),AJ=hJ;function u(J,Q){let j="";for(let Z=0;Z<J.length;Z++)if(j+=J[Z],Z<Q.length)j+=pJ(Q[Z]);return j}function pJ(J){if(typeof J==="string")return J;if(Array.isArray(J))return J.map((Q)=>u(Q.s,Q.d)).join("");if(J&&typeof J==="object"&&"s"in J&&"d"in J)return u(J.s,J.d);return""}function MJ(J,Q){if(!Q||!J)return;for(let j of Object.keys(Q)){let Z=parseInt(j,10),q=Q[j];if(typeof q==="string")J[Z]=q;else if(Array.isArray(q))J[Z]=q;else if(q&&typeof q==="object"){if("s"in q&&"d"in q)J[Z]=q;else if("d"in q){let Y=J[Z];if(Y&&typeof Y==="object"){if(Array.isArray(Y))DJ(Y,q.d);else if("d"in Y)r(Y,q.d)}}}}}function r(J,Q){if(!Q||!J.d)return;for(let j of Object.keys(Q)){let Z=parseInt(j,10),q=Q[j];if(typeof q==="string")J.d[Z]=q;else if(Array.isArray(q))J.d[Z]=q;else if(q&&typeof q==="object"){if("s"in q&&"d"in q)J.d[Z]=q;else if("d"in q){let Y=J.d[Z];if(Y&&typeof Y==="object"){if(Array.isArray(Y))DJ(Y,q.d);else if("d"in Y)r(Y,q.d)}}}}}function DJ(J,Q){if(!Q)return;for(let j of Object.keys(Q)){let Z=parseInt(j,10),q=Q[j];if(q&&typeof q==="object"){if("s"in q&&"d"in q)J[Z]=q;else if("d"in q){if(J[Z]&&typeof J[Z]==="object"&&"d"in J[Z])r(J[Z],q.d)}}}}var t=new WeakMap;class h{container;module;token;id;loomSocket;initialized=!1;pendingEvents=[];statics=null;dynamics=null;loadingElements=new Map;unsubReconnect;constructor(J,Q){this.container=J,this.module=J.dataset.lLive,this.token=J.dataset.lToken,this.loomSocket=Q,this.id=Q.allocateId(),Q.register(this.id,(j)=>this.handleMessage(j)),this.unsubReconnect=Q.onReconnect(()=>this.rejoin()),this.sendJoin(),this.attachEventListeners(),this.hideLoadingIndicators()}sendJoin(){this.loomSocket.send({type:"join",id:this.id,module:this.module,token:this.token}),this.initialized=!0;while(this.pendingEvents.length>0)this.sendEvent(this.pendingEvents.shift())}rejoin(){this.initialized=!1,this.statics=null,this.dynamics=null,this.sendJoin()}sendEvent(J){if(this.initialized)this.loomSocket.send(J);else this.pendingEvents.push(J)}handleMessage(J){switch(J.type){case"trees":this.statics=J.s,this.dynamics=J.d,this.clearLoadingStates();break;case"patch":if(this.clearLoadingStates(),this.statics&&this.dynamics){MJ(this.dynamics,J.d);let Q=u(this.statics,this.dynamics);this.applyPatch(Q)}break;case"error":this.clearLoadingStates(),console.error("[Loom] Server error:",J.error);break;default:console.warn("[Loom] Unknown message type:",J.type)}}applyPatch(J){let Q=XJ(),j=document.createElement("div");j.innerHTML=J,AJ(this.container,j,{childrenOnly:!0,getNodeKey:BJ,onBeforeElUpdated:(Z,q)=>{if(Z!==this.container&&Z.hasAttribute("data-l-live"))return!1;if(Z===Q.element&&Q.isInput)q.value=Z.value;return!0}}),this.attachEventListeners(),this.hideLoadingIndicators(),zJ(this.container,Q)}attachEventListeners(){this.container.querySelectorAll("[data-l-click], [data-l-input], [data-l-change], [data-l-submit], [data-l-keydown], [data-l-keyup], [data-l-focus], [data-l-blur]").forEach((Q)=>{if(Q.closest("[data-l-live]")!==this.container)return;this.attachElementListeners(Q)})}attachElementListeners(J){if(J._loomAttached)return;J._loomAttached=!0;let Q=WJ(J);qJ.forEach((j)=>{let Z=J.dataset[`l${j.charAt(0).toUpperCase()+j.slice(1)}`];if(!Z)return;J.addEventListener(j,(q)=>{this.handleEvent(q,j,Z,Q,J)})})}handleEvent(J,Q,j,Z,q){if(Z.prevent)J.preventDefault();if(Z.stop)J.stopPropagation();let Y={type:"event",id:this.id,handler:j,event:Q,special_vars:$J(J)};if(Z.shouldDebounce)this.debouncedSend(q,Y,Z.debounce);else{if(Q==="click"||Q==="submit")this.applyLoadingState(q);this.sendEvent(Y)}}applyLoadingState(J){let Q=J.hasAttribute("disabled");if(J.classList.add("l-loading"),!J.hasAttribute("l-no-disable"))J.setAttribute("disabled","");let j=J.getAttribute("l-loading-text"),Z=null;if(j!==null)Z=J.textContent,J.textContent=j;let{shownIndicators:q,hiddenSiblings:Y}=j===null?this.toggleLoadingChildren(J):{shownIndicators:[],hiddenSiblings:[]},X=[],G=J.id;if(G)this.container.querySelectorAll(`[l-loading="${G}"], [data-l-loading="${G}"]`).forEach((H)=>{let _=H;_.classList.add("l-loading");let R=this.toggleLoadingChildren(_);X.push({element:_,...R})});this.loadingElements.set(J,{originalText:Z,wasDisabled:Q,shownIndicators:q,hiddenSiblings:Y,remoteTargets:X})}toggleLoadingChildren(J){let Q=[],j=[];for(let Z of Array.from(J.children))if(this.isLoadingIndicator(Z))Z.style.display="",Q.push(Z);if(Q.length>0){for(let Z of Array.from(J.children))if(!this.isLoadingIndicator(Z))j.push({el:Z,originalDisplay:Z.style.display}),Z.style.display="none"}return{shownIndicators:Q,hiddenSiblings:j}}isLoadingIndicator(J){return J.getAttribute("l-loading")===""||J.getAttribute("data-l-loading")===""}clearLoadingStates(){this.loadingElements.forEach((J,Q)=>{if(Q.classList.remove("l-loading"),!J.wasDisabled)Q.removeAttribute("disabled");if(J.originalText!==null)Q.textContent=J.originalText;this.reverseChildToggle(J),J.remoteTargets.forEach((j)=>{j.element.classList.remove("l-loading"),this.reverseChildToggle(j)})}),this.loadingElements.clear()}reverseChildToggle(J){J.shownIndicators.forEach((Q)=>{Q.style.display="none"}),J.hiddenSiblings.forEach(({el:Q,originalDisplay:j})=>{Q.style.display=j})}hideLoadingIndicators(){this.container.querySelectorAll('[l-loading=""], [data-l-loading=""]').forEach((J)=>{J.style.display="none"})}debouncedSend(J,Q,j){clearTimeout(t.get(J)),t.set(J,setTimeout(()=>{t.delete(J),this.sendEvent(Q)},j))}destroy(){this.unsubReconnect(),this.loomSocket.unregister(this.id),this.initialized=!1}}class p{destroyLive;initLive;cache=new Map;scrollPositions=new Map;navCounter=0;currentNavId;prefetchTimer=null;prefetchController=null;inflightFetches=new Map;navigationController=null;enabled=!1;boundHandleClick;boundHandleMouseOver;boundHandleMouseOut;boundHandlePopState;boundHandleSubmit;constructor(J,Q){this.destroyLive=J,this.initLive=Q,this.currentNavId=this.nextNavId(),this.boundHandleClick=this.handleClick.bind(this),this.boundHandleMouseOver=this.handleMouseOver.bind(this),this.boundHandleMouseOut=this.handleMouseOut.bind(this),this.boundHandlePopState=this.handlePopState.bind(this),this.boundHandleSubmit=this.handleSubmit.bind(this)}enable(){if(this.enabled)return;this.enabled=!0,history.replaceState({loomNavId:this.currentNavId,url:location.href},"",location.href),document.addEventListener("click",this.boundHandleClick),document.addEventListener("mouseover",this.boundHandleMouseOver),document.addEventListener("mouseout",this.boundHandleMouseOut),document.addEventListener("submit",this.boundHandleSubmit),window.addEventListener("popstate",this.boundHandlePopState)}disable(){if(!this.enabled)return;this.enabled=!1,document.removeEventListener("click",this.boundHandleClick),document.removeEventListener("mouseover",this.boundHandleMouseOver),document.removeEventListener("mouseout",this.boundHandleMouseOut),document.removeEventListener("submit",this.boundHandleSubmit),window.removeEventListener("popstate",this.boundHandlePopState),this.cancelPrefetch()}async navigate(J){await this.performNavigation(J,!1)}handleClick(J){if(J.button!==0)return;if(J.metaKey||J.ctrlKey||J.shiftKey||J.altKey)return;let Q=J.target.closest?.("a");if(!Q)return;if(!this.shouldInterceptLink(Q))return;J.preventDefault(),this.performNavigation(Q.href,!1)}shouldInterceptLink(J){if(J.closest("[data-l-no-nav], [l-no-nav]"))return!1;if(J.hasAttribute("download"))return!1;let Q=J.getAttribute("target");if(Q&&Q!=="_self")return!1;if(!J.getAttribute("href"))return!1;let Z=J.protocol;if(Z&&Z!=="http:"&&Z!=="https:")return!1;if(J.origin!==location.origin)return!1;if(J.pathname===location.pathname&&J.search===location.search&&J.hash!=="")return!1;return!0}handleSubmit(J){let Q=J.target;if(!this.shouldInterceptForm(Q))return;J.preventDefault();let j=new URL(Q.action||location.href,location.origin),Z=new URLSearchParams(new FormData(Q));j.search=Z.toString(),this.performNavigation(j.href,!1)}shouldInterceptForm(J){if((J.method||"GET").toUpperCase()!=="GET")return!1;if(J.closest("[data-l-no-nav], [l-no-nav]"))return!1;let j=J.getAttribute("target");if(j&&j!=="_self")return!1;if(J.enctype==="multipart/form-data")return!1;if((J.action?new URL(J.action,location.origin):new URL(location.href)).origin!==location.origin)return!1;return!0}handleMouseOver(J){let Q=J.target.closest?.("a");if(!Q||!this.shouldInterceptLink(Q))return;let j=this.normalizeUrl(Q.href);if(this.cacheGet(j))return;this.cancelPrefetch(),this.prefetchTimer=setTimeout(()=>{this.prefetchController=new AbortController;let Z=this.fetchPage(j,this.prefetchController.signal);this.inflightFetches.set(j,Z),Z.then((q)=>{if(this.inflightFetches.delete(j),q)this.cacheSet(j,q)},()=>{this.inflightFetches.delete(j)})},M.navPrefetchDelay)}handleMouseOut(J){if(!J.target.closest?.("a"))return;this.cancelPrefetch()}cancelPrefetch(){if(this.prefetchTimer)clearTimeout(this.prefetchTimer),this.prefetchTimer=null;if(this.prefetchController)this.prefetchController.abort(),this.prefetchController=null}normalizeUrl(J){return new URL(J,location.origin).href}cacheGet(J){let Q=this.cache.get(J);if(!Q)return null;if(Date.now()-Q.timestamp>M.navCacheTTL)return this.cache.delete(J),null;return Q}cacheSet(J,Q){if(this.cache.size>=M.navCacheMaxEntries){let j=this.cache.keys().next().value;this.cache.delete(j)}this.cache.set(J,Q)}async fetchPage(J,Q){try{let j=await fetch(J,{headers:{Accept:"text/html"},signal:Q});if(!j.ok)return null;if(!(j.headers.get("Content-Type")||"").includes("text/html"))return null;let q=await j.text(),Y=this.parsePage(q);if(j.redirected)Y.resolvedUrl=j.url;return Y}catch{return null}}parsePage(J){let Q=new DOMParser().parseFromString(J,"text/html"),j=[];Q.querySelectorAll("head meta[name], head meta[property]").forEach((Y)=>j.push(Y.outerHTML));let Z=[];Q.querySelectorAll('head link[rel="stylesheet"]').forEach((Y)=>Z.push(Y.outerHTML));let q=[];return Q.querySelectorAll("head style").forEach((Y)=>q.push(Y.outerHTML)),{html:Q.body.innerHTML,title:Q.title,headMeta:j,headLinks:Z,headStyles:q,timestamp:Date.now()}}async performNavigation(J,Q){if(this.navigationController)this.navigationController.abort();this.navigationController=new AbortController;let j=this.navigationController.signal,Z=this.normalizeUrl(J),q=new CustomEvent("loom:before-navigate",{cancelable:!0,detail:{url:Z,isPopState:Q}});if(!document.dispatchEvent(q))return;let Y=this.cacheGet(Z);if(!Y){let G=this.inflightFetches.get(Z);if(G)Y=await G;else Y=await this.fetchPage(Z,j)}if(j.aborted)return;if(!Y){window.location.href=J;return}let X=Y.resolvedUrl||Z;if(this.scrollPositions.set(this.currentNavId,{x:window.scrollX,y:window.scrollY}),this.destroyLive(),this.swapBody(Y.html),document.title=Y.title,this.mergeHead(Y),this.reExecuteScripts(),!Q)this.currentNavId=this.nextNavId(),history.pushState({loomNavId:this.currentNavId,url:X},"",X);if(this.initLive(),Q){let H=history.state?.loomNavId;if(H){let _=this.scrollPositions.get(H);if(_)window.scrollTo(_.x,_.y)}}else{let G=new URL(X).hash;if(G){let H=document.querySelector(G);if(H)H.scrollIntoView();else window.scrollTo(0,0)}else window.scrollTo(0,0)}document.dispatchEvent(new CustomEvent("loom:after-navigate",{detail:{url:X,isPopState:Q}}))}mergeHead(J){let Q=new Set;for(let Z of J.headMeta){let q=document.createElement("div");q.innerHTML=Z;let Y=q.firstChild;if(!Y)continue;let X=Y.getAttribute("name"),G=Y.getAttribute("property");if(X)Q.add(`name:${X}`);else if(G)Q.add(`property:${G}`)}document.head.querySelectorAll("meta[name], meta[property]").forEach((Z)=>{let q=Z.getAttribute("name"),Y=Z.getAttribute("property"),X=q?`name:${q}`:Y?`property:${Y}`:null;if(X&&!Q.has(X))Z.remove()});for(let Z of J.headMeta){let q=document.createElement("div");q.innerHTML=Z;let Y=q.firstChild;if(!Y)continue;let X=Y.getAttribute("name"),G=Y.getAttribute("property"),H=X?`meta[name="${X}"]`:G?`meta[property="${G}"]`:null;if(H){let _=document.head.querySelector(H);if(_)_.replaceWith(Y);else document.head.appendChild(Y)}}let j=new Set;for(let Z of J.headLinks){let q=document.createElement("div");q.innerHTML=Z;let X=q.firstChild?.getAttribute("href");if(X)j.add(X)}document.head.querySelectorAll('link[rel="stylesheet"]').forEach((Z)=>{let q=Z.getAttribute("href");if(q&&!j.has(q))Z.remove()});for(let Z of J.headLinks){let q=document.createElement("div");q.innerHTML=Z;let Y=q.firstChild;if(!Y)continue;let X=Y.getAttribute("href");if(X&&!document.head.querySelector(`link[href="${X}"]`))document.head.appendChild(Y)}document.head.querySelectorAll("style").forEach((Z)=>Z.remove());for(let Z of J.headStyles){let q=document.createElement("div");q.innerHTML=Z;let Y=q.firstChild;if(Y)document.head.appendChild(Y)}}swapBody(J){let Q=document.createElement("template");Q.innerHTML=J,document.body.replaceChildren(...Q.content.childNodes)}reExecuteScripts(){document.body.querySelectorAll("script").forEach((J)=>{let Q=document.createElement("script");for(let j of J.attributes)Q.setAttribute(j.name,j.value);Q.textContent=J.textContent,J.replaceWith(Q)})}handlePopState(J){let Q=J.state;if(!Q?.loomNavId){window.location.reload();return}this.currentNavId=Q.loomNavId,this.performNavigation(Q.url,!0)}nextNavId(){return`nav-${++this.navCounter}`}}var N=null,o=[],c=()=>{let J=document.querySelectorAll("[data-l-live]");if(J.length>0&&!N){let Q=J[0].dataset.lWs||null;N=new y(Q)}J.forEach((Q)=>{if(Q._loomInstance)return;let j=new h(Q,N);Q._loomInstance=j,o.push(j)}),console.log(`[Loom] Initialized ${J.length} live component(s)`)},NJ=()=>{o.forEach((J)=>J.destroy()),o=[],document.querySelectorAll("[data-l-live]").forEach((J)=>{delete J._loomInstance})},cJ=()=>{c()},e=new p(NJ,cJ);e.enable();c();window.Loom={init:c,reinit:c,LoomLive:h,LoomSocket:y,LoomNav:p,CONFIG:M,get socket(){return N},get nav(){return e},navigate:(J)=>e.navigate(J)};
